# Script de diagnostic interactif des services
# D√©sactive les services groupe par groupe jusqu'√† trouver le probl√®me

param(
    [Parameter(Mandatory=$false)]
    [ValidateSet("capture", "interactive")]
    [string]$Mode = "interactive",
    
    [Parameter(Mandatory=$false)]
    [int]$GroupSize = 20,
    
    [Parameter(Mandatory=$false)]
    [string]$LogPath = "C:\Temp\ServiceDiagnostic"
)

# V√©rification des privil√®ges administrateur
if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Error "Ce script doit √™tre ex√©cut√© en tant qu'administrateur!"
    Write-Host "Clic droit sur PowerShell -> Ex√©cuter en tant qu'administrateur" -ForegroundColor Yellow
    Read-Host "Appuyez sur Entr√©e pour quitter"
    exit
}

# Cr√©ation du dossier de logs
if (!(Test-Path $LogPath)) {
    New-Item -ItemType Directory -Path $LogPath -Force
}

$SafeModeServicesFile = "$LogPath\SafeModeServices.json"
$NormalModeServicesFile = "$LogPath\NormalModeServices.json"
$DiagnosticLogFile = "$LogPath\DiagnosticLog.txt"

# Fonction pour obtenir les services en cours d'ex√©cution
function Get-RunningServices {
    return Get-Service | Where-Object {$_.Status -eq "Running"} | Select-Object Name, DisplayName, StartType
}

# Fonction pour √©crire dans le log
function Write-Log {
    param([string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$timestamp - $Message" | Out-File -FilePath $DiagnosticLogFile -Append
    Write-Host $Message
}

# Fonction pour demander confirmation √† l'utilisateur
function Ask-User {
    param([string]$Question)
    
    do {
        Write-Host "`n$Question" -ForegroundColor Cyan
        Write-Host "[O]ui / [N]on / [A]rr√™ter le diagnostic" -ForegroundColor Yellow
        $response = Read-Host "Votre choix"
        $response = $response.ToUpper().Trim()
        
        if ($response -eq "A" -or $response -eq "ARRETER") {
            Write-Host "Diagnostic arr√™t√© par l'utilisateur." -ForegroundColor Red
            return "STOP"
        }
        
        if ($response -eq "O" -or $response -eq "OUI") {
            return $true
        }
        
        if ($response -eq "N" -or $response -eq "NON") {
            return $false
        }
        
        Write-Host "R√©ponse non reconnue. Utilisez O/Oui, N/Non ou A/Arr√™ter" -ForegroundColor Red
        
    } while ($true)
}

# Fonction pour afficher les services d'un groupe
function Show-ServiceGroup {
    param([array]$Services, [int]$GroupNumber, [int]$TotalGroups)
    
    Write-Host "`n=== GROUPE $GroupNumber/$TotalGroups ===" -ForegroundColor Green
    Write-Host "Services qui vont √™tre d√©sactiv√©s:" -ForegroundColor Yellow
    foreach ($service in $Services) {
        Write-Host "  - $($service.DisplayName) ($($service.Name))" -ForegroundColor White
    }
}

# Fonction pour d√©sactiver un groupe de services
function Disable-ServiceGroup {
    param([array]$Services)
    
    $disabledServices = @()
    foreach ($service in $Services) {
        try {
            $svc = Get-Service -Name $service.Name -ErrorAction SilentlyContinue
            if ($svc -and $svc.Status -eq "Running") {
                Write-Host "  Arr√™t de: $($service.DisplayName)" -ForegroundColor Gray
                Stop-Service -Name $service.Name -Force -ErrorAction SilentlyContinue
                $disabledServices += $service
                Write-Log "Service arr√™t√©: $($service.DisplayName) ($($service.Name))"
            }
        } catch {
            Write-Warning "Impossible d'arr√™ter: $($service.DisplayName) - $($_.Exception.Message)"
            Write-Log "ERREUR - Impossible d'arr√™ter: $($service.DisplayName) - $($_.Exception.Message)"
        }
    }
    return $disabledServices
}

# Fonction pour r√©activer un groupe de services
function Enable-ServiceGroup {
    param([array]$Services)
    
    foreach ($service in $Services) {
        try {
            $svc = Get-Service -Name $service.Name -ErrorAction SilentlyContinue
            if ($svc -and $svc.Status -eq "Stopped") {
                Write-Host "  Red√©marrage de: $($service.DisplayName)" -ForegroundColor Gray
                Start-Service -Name $service.Name -ErrorAction SilentlyContinue
                Write-Log "Service red√©marr√©: $($service.DisplayName) ($($service.Name))"
            }
        } catch {
            Write-Warning "Impossible de red√©marrer: $($service.DisplayName) - $($_.Exception.Message)"
            Write-Log "ERREUR - Impossible de red√©marrer: $($service.DisplayName) - $($_.Exception.Message)"
        }
    }
}

# Mode Capture (en mode sans √©chec)
if ($Mode -eq "capture") {
    Write-Host "=== MODE CAPTURE ===" -ForegroundColor Green
    Write-Host "Capture des services en mode sans √©chec..." -ForegroundColor Yellow
    
    if ((Get-WmiObject -Class Win32_ComputerSystem).BootupState -notmatch "Safe") {
        Write-Warning "ATTENTION: Il est recommand√© d'ex√©cuter ce mode en mode sans √©chec!"
        $continue = Ask-User "Voulez-vous continuer quand m√™me?"
        if ($continue.ToString() -eq "STOP" -or $continue.ToString() -eq "False") {
            Write-Host "Op√©ration annul√©e." -ForegroundColor Red
            return
        }
    }
    
    $safeModeServices = Get-RunningServices
    $safeModeServices | ConvertTo-Json | Out-File $SafeModeServicesFile
    Write-Log "Services captur√©s en mode sans √©chec: $($safeModeServices.Count)"
    
    Write-Host "Services captur√©s: $($safeModeServices.Count)" -ForegroundColor Green
    Write-Host "Red√©marrez en mode normal et ex√©cutez le diagnostic interactif." -ForegroundColor Cyan
}

# Mode Interactif (diagnostic pas √† pas)
elseif ($Mode -eq "interactive") {
    Write-Host "=== DIAGNOSTIC INTERACTIF ===" -ForegroundColor Green
    Write-Log "D√©but du diagnostic interactif"
    
    # V√©rification des fichiers de r√©f√©rence
    if (!(Test-Path $SafeModeServicesFile)) {
        Write-Host "Aucun fichier de r√©f√©rence trouv√©." -ForegroundColor Yellow
        $createReference = Ask-User "Voulez-vous cr√©er une r√©f√©rence avec l'√©tat actuel?"
        
        if ($createReference.ToString() -eq "STOP") { return }
        
        if ($createReference.ToString() -eq "True") {
            Write-Host "Cr√©ation de la r√©f√©rence..." -ForegroundColor Yellow
            $currentServices = Get-RunningServices
            
            # Exclure les services Windows essentiels
            $essentialServices = @(
                "Winmgmt", "RpcSs", "DcomLaunch", "PlugPlay", "Power", "Themes", 
                "AudioSrv", "AudioEndpointBuilder", "Dhcp", "Dnscache", "LanmanServer",
                "LanmanWorkstation", "NlaSvc", "nsi", "WinHttpAutoProxySvc", "Spooler",
                "EventLog", "Schedule", "ProfSvc", "UxSms", "SessionEnv", "TermService"
            )
            
            $referenceServices = $currentServices | Where-Object {$_.Name -notin $essentialServices}
            $referenceServices | ConvertTo-Json | Out-File $SafeModeServicesFile
            Write-Log "R√©f√©rence cr√©√©e avec $($referenceServices.Count) services"
            Write-Host "R√©f√©rence cr√©√©e avec $($referenceServices.Count) services" -ForegroundColor Green
        } else {
            Write-Host "Diagnostic annul√©. Cr√©ez d'abord une r√©f√©rence." -ForegroundColor Red
            return
        }
    }
    
    # Chargement des services de r√©f√©rence
    $referenceServices = Get-Content $SafeModeServicesFile | ConvertFrom-Json
    $currentServices = Get-RunningServices
    
    # Identification des services suppl√©mentaires
    $referenceNames = $referenceServices.Name
    $additionalServices = $currentServices | Where-Object {$_.Name -notin $referenceNames}
    
    if ($additionalServices.Count -eq 0) {
        Write-Host "Aucun service suppl√©mentaire d√©tect√©!" -ForegroundColor Yellow
        Write-Host "Le probl√®me pourrait venir d'ailleurs (applications, pilotes, etc.)" -ForegroundColor Yellow
        Write-Log "Aucun service suppl√©mentaire d√©tect√©"
        return
    }
    
    Write-Host "`nServices suppl√©mentaires d√©tect√©s: $($additionalServices.Count)" -ForegroundColor Cyan
    Write-Log "Services suppl√©mentaires d√©tect√©s: $($additionalServices.Count)"
    
    # Affichage de la liste compl√®te
    Write-Host "`nListe des services qui seront test√©s:" -ForegroundColor Yellow
    $additionalServices | ForEach-Object {
        Write-Host "  - $($_.DisplayName) ($($_.Name))" -ForegroundColor White
    }
    
    # Confirmation pour commencer
    $startDiagnostic = Ask-User "Voulez-vous commencer le diagnostic interactif?"
    Write-Host "DEBUG: Valeur retourn√©e = '$startDiagnostic' (Type: $($startDiagnostic.GetType().Name))" -ForegroundColor Magenta
    
    # Logique simplifi√©e
    if ($startDiagnostic.ToString() -eq "STOP") {
        Write-Host "Diagnostic annul√© par STOP." -ForegroundColor Red
        return
    }
    
    if ($startDiagnostic.ToString() -eq "False") {
        Write-Host "Diagnostic annul√© par NON." -ForegroundColor Red
        return
    }
    
    # Si on arrive ici, c'est forc√©ment True
    Write-Host "DEBUG: Continuons le diagnostic..." -ForegroundColor Magenta
    
    # Test initial
    Write-Host "`n=== TEST INITIAL ===" -ForegroundColor Green
    Write-Host "Testez votre probl√®me maintenant (upload lent, etc.)" -ForegroundColor Yellow
    $initialProblem = Ask-User "Le probl√®me est-il pr√©sent actuellement?"
    
    if ($initialProblem.ToString() -eq "STOP") { 
        Write-Host "Diagnostic arr√™t√©." -ForegroundColor Red
        return 
    }
    
    if ($initialProblem.ToString() -eq "False") {
        Write-Host "Le probl√®me n'est pas pr√©sent. Diagnostic non n√©cessaire." -ForegroundColor Green
        Write-Log "Probl√®me non pr√©sent lors du test initial"
        return
    }
    
    Write-Log "Probl√®me confirm√© lors du test initial"
    
    # Division en groupes
    $serviceGroups = @()
    for ($i = 0; $i -lt $additionalServices.Count; $i += $GroupSize) {
        $group = $additionalServices[$i..([Math]::Min($i + $GroupSize - 1, $additionalServices.Count - 1))]
        $serviceGroups += ,$group
    }
    
    Write-Host "`nServices divis√©s en $($serviceGroups.Count) groupes de $GroupSize services maximum" -ForegroundColor Cyan
    Write-Host "Pour cibler plus rapidement, les groupes sont volontairement larges (20 services)" -ForegroundColor Gray
    Write-Log "Services divis√©s en $($serviceGroups.Count) groupes de $GroupSize services"
    
    # Diagnostic groupe par groupe
    $allDisabledServices = @()
    $problemFound = $false
    
    for ($groupIndex = 0; $groupIndex -lt $serviceGroups.Count; $groupIndex++) {
        if ($problemFound) { break }
        
        $currentGroup = $serviceGroups[$groupIndex]
        Show-ServiceGroup -Services $currentGroup -GroupNumber ($groupIndex + 1) -TotalGroups $serviceGroups.Count
        
        $continueWithGroup = Ask-User "Voulez-vous d√©sactiver ce groupe?"
        if ($continueWithGroup.ToString() -eq "STOP") { break }
        
        if ($continueWithGroup.ToString() -eq "True") {
            Write-Host "`nD√©sactivation du groupe..." -ForegroundColor Yellow
            $disabledInGroup = Disable-ServiceGroup -Services $currentGroup
            $allDisabledServices += $disabledInGroup
            
            Write-Host "`nAttendez 3 secondes..." -ForegroundColor Gray
            Start-Sleep -Seconds 3
            
            Write-Host "`n=== TEST APR√àS D√âSACTIVATION ===" -ForegroundColor Green
            Write-Host "Testez maintenant votre probl√®me (upload, etc.)" -ForegroundColor Yellow
            $problemStillPresent = Ask-User "Le probl√®me est-il toujours pr√©sent?"
            
            if ($problemStillPresent.ToString() -eq "STOP") { break }
            
            if ($problemStillPresent.ToString() -eq "False") {
                Write-Host "`nüéâ PROBL√àME R√âSOLU! üéâ" -ForegroundColor Green
                Write-Host "Le probl√®me vient de l'un des services de ce groupe:" -ForegroundColor Yellow
                
                foreach ($service in $disabledInGroup) {
                    Write-Host "  - $($service.DisplayName) ($($service.Name))" -ForegroundColor Red
                }
                
                Write-Log "PROBL√àME TROUV√â - Groupe $($groupIndex + 1): $($disabledInGroup.Count) services"
                foreach ($service in $disabledInGroup) {
                    Write-Log "SERVICE SUSPECT: $($service.DisplayName) ($($service.Name))"
                }
                
                if ($disabledInGroup.Count -gt 1) {
                    Write-Host "`nLe groupe contenait $($disabledInGroup.Count) services." -ForegroundColor Cyan
                    Write-Host "Voulez-vous:" -ForegroundColor Yellow
                    Write-Host "1. Tester individuellement chaque service (plus pr√©cis)" -ForegroundColor White
                    Write-Host "2. Diviser le groupe en plus petits groupes (plus rapide)" -ForegroundColor White
                    Write-Host "3. Laisser comme √ßa (tous ces services restent d√©sactiv√©s)" -ForegroundColor White
                    
                    do {
                        $choice = Read-Host "Votre choix (1/2/3)"
                    } while ($choice -notin @("1", "2", "3"))
                    
                    if ($choice -eq "1") {
                        # Test individuel (code existant)
                        Write-Host "`nRed√©marrage de tous les services du groupe..." -ForegroundColor Yellow
                        Enable-ServiceGroup -Services $disabledInGroup
                        Start-Sleep -Seconds 2
                        
                        foreach ($service in $disabledInGroup) {
                            Write-Host "`n--- Test individuel: $($service.DisplayName) ---" -ForegroundColor Cyan
                            Write-Host "D√©sactivation de: $($service.DisplayName)" -ForegroundColor Yellow
                            
                            $singleDisabled = Disable-ServiceGroup -Services @($service)
                            Start-Sleep -Seconds 2
                            
                            $individualTest = Ask-User "Le probl√®me est-il r√©solu avec juste ce service d√©sactiv√©?"
                            if ($individualTest.ToString() -eq "STOP") { break }
                            
                            if ($individualTest.ToString() -eq "True") {
                                Write-Host "`nüéØ COUPABLE TROUV√â! üéØ" -ForegroundColor Red
                                Write-Host "Service responsable: $($service.DisplayName) ($($service.Name))" -ForegroundColor Red
                                Write-Log "COUPABLE IDENTIFI√â: $($service.DisplayName) ($($service.Name))"
                                $problemFound = $true
                                break
                            } else {
                                Write-Host "Ce n'est pas ce service, red√©marrage..." -ForegroundColor Gray
                                Enable-ServiceGroup -Services @($service)
                                Start-Sleep -Seconds 2
                            }
                        }
                    }
                    elseif ($choice -eq "2") {
                        # Division en plus petits groupes
                        Write-Host "`nDivision en groupes de 5 services..." -ForegroundColor Yellow
                        Enable-ServiceGroup -Services $disabledInGroup
                        Start-Sleep -Seconds 2
                        
                        $smallGroups = @()
                        for ($i = 0; $i -lt $disabledInGroup.Count; $i += 5) {
                            $smallGroup = $disabledInGroup[$i..([Math]::Min($i + 4, $disabledInGroup.Count - 1))]
                            $smallGroups += ,$smallGroup
                        }
                        
                        foreach ($smallGroupIndex in 0..($smallGroups.Count - 1)) {
                            $smallGroup = $smallGroups[$smallGroupIndex]
                            Write-Host "`n--- Sous-groupe $($smallGroupIndex + 1)/$($smallGroups.Count) ---" -ForegroundColor Cyan
                            
                            foreach ($service in $smallGroup) {
                                Write-Host "  - $($service.DisplayName)" -ForegroundColor White
                            }
                            
                            $testSmallGroup = Ask-User "Voulez-vous d√©sactiver ce sous-groupe?"
                            if ($testSmallGroup.ToString() -eq "STOP") { break }
                            
                            if ($testSmallGroup.ToString() -eq "True") {
                                $disabledSmall = Disable-ServiceGroup -Services $smallGroup
                                Start-Sleep -Seconds 2
                                
                                $testSmallResult = Ask-User "Le probl√®me est-il r√©solu?"
                                if ($testSmallResult.ToString() -eq "True") {
                                    Write-Host "`nüéØ GROUPE COUPABLE TROUV√â! üéØ" -ForegroundColor Red
                                    Write-Host "Services responsables dans ce sous-groupe:" -ForegroundColor Red
                                    foreach ($service in $disabledSmall) {
                                        Write-Host "  - $($service.DisplayName) ($($service.Name))" -ForegroundColor Red
                                        Write-Log "SERVICE SUSPECT: $($service.DisplayName) ($($service.Name))"
                                    }
                                    $problemFound = $true
                                    break
                                } else {
                                    Enable-ServiceGroup -Services $disabledSmall
                                    Start-Sleep -Seconds 1
                                }
                            }
                        }
                    }
                    else {
                        Write-Host "Tous les services du groupe restent d√©sactiv√©s." -ForegroundColor Yellow
                    }
                }
                
                $problemFound = $true
            } else {
                Write-Host "Le probl√®me persiste, passage au groupe suivant..." -ForegroundColor Gray
                Write-Log "Probl√®me persiste apr√®s groupe $($groupIndex + 1)"
            }
        }
    }
    
    if (-not $problemFound -and $allDisabledServices.Count -gt 0) {
        Write-Host "`n‚ö†Ô∏è Le probl√®me n'a pas √©t√© identifi√© dans les services test√©s." -ForegroundColor Yellow
        Write-Host "Le probl√®me pourrait venir d'applications de d√©marrage, pilotes, ou autre." -ForegroundColor Yellow
        Write-Log "Probl√®me non identifi√© dans les services test√©s"
    }
    
    # Proposition de restauration
    if ($allDisabledServices.Count -gt 0) {
        Write-Host "`n=== RESTAURATION ===" -ForegroundColor Cyan
        Write-Host "Services actuellement d√©sactiv√©s: $($allDisabledServices.Count)" -ForegroundColor White
        
        if (-not $problemFound) {
            $restoreServices = Ask-User "Voulez-vous r√©activer tous les services d√©sactiv√©s?"
            if ($restoreServices.ToString() -eq "True") {
                Write-Host "R√©activation de tous les services..." -ForegroundColor Yellow
                Enable-ServiceGroup -Services $allDisabledServices
                Write-Host "Services r√©activ√©s." -ForegroundColor Green
                Write-Log "Tous les services ont √©t√© r√©activ√©s"
            }
        } else {
            Write-Host "Les services responsables du probl√®me restent d√©sactiv√©s." -ForegroundColor Yellow
            Write-Host "Vous pouvez les r√©activer manuellement via services.msc si n√©cessaire." -ForegroundColor Gray
        }
    }
    
    Write-Host "`nDiagnostic termin√©! Log disponible dans: $DiagnosticLogFile" -ForegroundColor Green
    Write-Log "Diagnostic termin√©"
}

Write-Host "`nAppuyez sur Entr√©e pour fermer..." -ForegroundColor Gray
Read-Host
